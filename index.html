<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoContaLabs - Procesador Final</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f3f4f6;
            --text-dark: #111827;
            --text-gray: #6b7280;
            --card-radius: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-dark);
        }

        .dashboard-card {
            background: white;
            width: 100%;
            max-width: 520px;
            padding: 40px;
            border-radius: var(--card-radius);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            text-align: center;
            animation: floatUp 0.6s ease-out;
        }

        .icon-header {
            background: #eff6ff;
            color: var(--primary);
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px auto;
            font-size: 32px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        p.subtitle {
            color: var(--text-gray);
            font-size: 14px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .upload-zone {
            border: 2px dashed #e5e7eb;
            border-radius: 16px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .upload-zone input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-content i {
            font-size: 28px;
            color: #9ca3af;
            margin-bottom: 10px;
            display: block;
        }

        .upload-content span {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-gray);
        }

        .file-selected {
            color: var(--primary) !important;
            font-weight: 600 !important;
        }

        .btn-process {
            background-color: var(--primary);
            color: white;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 24px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-process:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-process:active {
            transform: translateY(1px);
        }

        .btn-process:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-msg {
            margin-top: 20px;
            font-size: 13px;
            padding: 12px;
            border-radius: 12px;
            display: none;
        }

        .status-loading {
            background: #eff6ff;
            color: var(--primary);
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        @keyframes floatUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-card">
        <div class="icon-header">
            <i class="ph ph-file-zip"></i>
        </div>

        <h1>AutoContaLabs</h1>
        <p class="subtitle">Mapeo de Compras + Plantilla + TXTs</p>

        <div class="upload-zone" id="dropZone">
            <div class="upload-content">
                <i class="ph ph-cloud-arrow-up" id="uploadIcon"></i>
                <span id="uploadText">Haz clic para subir tu Excel (Compras)</span>
            </div>
            <input type="file" id="inputFile" accept=".xlsx, .xls" onchange="actualizarNombreArchivo()">
        </div>

        <button class="btn-process" id="btnProcess" onclick="procesarCompleto()">
            Procesar y Descargar ZIP
        </button>

        <div id="statusArea" class="status-msg"></div>
    </div>

    <script>
        // CONFIGURACIÓN
        // Asegúrate de que este archivo exista en tu repositorio con este nombre exacto
        const NOMBRE_PLANTILLA = './Plantilla_Control_Calidad.xlsx';

        function actualizarNombreArchivo() {
            const input = document.getElementById('inputFile');
            const text = document.getElementById('uploadText');
            const icon = document.getElementById('uploadIcon');

            if (input.files && input.files[0]) {
                text.innerText = input.files[0].name;
                text.classList.add('file-selected');
                icon.className = "ph ph-file-xls";
                icon.style.color = "#2563eb";
            }
        }

        function mostrarEstado(msg, tipo) {
            const div = document.getElementById('statusArea');
            div.style.display = 'block';
            div.className = 'status-msg status-' + tipo;
            div.innerHTML = msg;
        }

        // Función auxiliar para parsear fechas
        function obtenerFechaStr(valorCelda) {
            if (valorCelda instanceof Date) {
                // Ajuste de zona horaria simple para fechas Excel
                const d = new Date(valorCelda.getTime() + Math.abs(valorCelda.getTimezoneOffset() * 60000));
                return d.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            return valorCelda ? valorCelda.toString().trim() : "";
        }

        async function procesarCompleto() {
            const fileInput = document.getElementById('inputFile');
            const btn = document.getElementById('btnProcess');

            if (!fileInput.files[0]) {
                mostrarEstado("Por favor selecciona un archivo primero.", "error");
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="ph ph-spinner-gap ph-spin"></i> Procesando...';
                mostrarEstado("1. Leyendo archivos...", "loading");

                // 1. LEER ARCHIVO DE ENTRADA
                const reader = new FileReader();
                reader.readAsArrayBuffer(fileInput.files[0]);

                reader.onload = async function (e) {
                    try {
                        const bufferEntrada = e.target.result;
                        const wbEntrada = new ExcelJS.Workbook();
                        await wbEntrada.xlsx.load(bufferEntrada);
                        const wsEntrada = wbEntrada.worksheets[0]; // Hoja 1

                        // 2. DESCARGAR PLANTILLA
                        mostrarEstado("2. Cargando plantilla...", "loading");
                        const respPlantilla = await fetch(NOMBRE_PLANTILLA);
                        if (!respPlantilla.ok) throw new Error("No se encontró 'Plantilla_Control_Calidad.xlsx' en el servidor.");
                        const bufferPlantilla = await respPlantilla.arrayBuffer();

                        const wbSalida = new ExcelJS.Workbook();
                        await wbSalida.xlsx.load(bufferPlantilla);
                        const wsSalida = wbSalida.worksheets[0]; // Hoja 1 de plantilla

                        // 3. COPIAR CABECERA (A1:B5)
                        // Filas 1 a 5, Columnas 1 (A) y 2 (B)
                        for (let r = 1; r <= 5; r++) {
                            const valA = wsEntrada.getCell(r, 1).value;
                            const valB = wsEntrada.getCell(r, 2).value;
                            wsSalida.getCell(r, 1).value = valA;
                            wsSalida.getCell(r, 2).value = valB;
                        }

                        // 4. MAPEO DE DATOS Y FILTRADO
                        mostrarEstado("3. Procesando y mapeando datos...", "loading");
                        const regexFecha = /\d{2}\/\d{2}\/\d{4}/;
                        let datosMapeados = [];

                        // Recorrer filas entrada. ExcelJS empieza en 1.
                        // Asumimos que los datos pueden empezar en cualquier fila, chequeamos col B (2)
                        wsEntrada.eachRow({ includeEmpty: false }, function (row, rowNumber) {
                            const valFecha = row.getCell(2).value; // Col B
                            const strFecha = obtenerFechaStr(valFecha);

                            // Filtro Regex Fecha
                            if (regexFecha.test(strFecha)) {
                                // MAPEO SOLICITADO
                                // Python es base 0, ExcelJS base 1.
                                // A(0)->1, B(1)->2, D(3)->4, E(4)->5, G(6)->7, H(7)->8, I(8)->9, J(9)->10
                                // K(10)->11, L(11)->12, Q(16)->17, V(21)->22, AA(26)->27, AB(27)->28, AC(28)->29, AD(29)->30

                                const objFila = {
                                    colA: row.getCell(1).value,  // Destino A
                                    colB: row.getCell(2).value,  // Destino B
                                    colC: row.getCell(4).value,  // Destino C (Origen D)
                                    colD: row.getCell(5).value,  // Destino D (Origen E)
                                    colE: row.getCell(7).value,  // Destino E (Origen G)
                                    colF: row.getCell(8).value,  // Destino F (Origen H)
                                    colG: row.getCell(9).value,  // Destino G (Origen I)
                                    colH: row.getCell(10).value, // Destino H (Origen J)
                                    colI: row.getCell(11).value, // Destino I (Origen K)
                                    colJ: row.getCell(12).value, // Destino J (Origen L)
                                    colK: row.getCell(17).value, // Destino K (Origen Q)
                                    colL: row.getCell(22).value, // Destino L (Origen V)
                                    colM: row.getCell(27).value, // Destino M (Origen AA)
                                    colN: row.getCell(28).value, // Destino N (Origen AB)
                                    colO: row.getCell(29).value, // Destino O (Origen AC)
                                    colP: row.getCell(30).value  // Destino P (Origen AD)
                                };
                                datosMapeados.push(objFila);
                            }
                        });

                        // 5. ESCRIBIR EN PLANTILLA (Desde fila 12)
                        let filaInicio = 12;
                        datosMapeados.forEach((d, index) => {
                            const r = filaInicio + index;
                            const filaExcel = wsSalida.getRow(r);

                            filaExcel.getCell(1).value = d.colA;
                            filaExcel.getCell(2).value = d.colB;
                            filaExcel.getCell(3).value = d.colC;
                            filaExcel.getCell(4).value = d.colD;
                            filaExcel.getCell(5).value = d.colE;
                            filaExcel.getCell(6).value = d.colF;
                            filaExcel.getCell(7).value = d.colG;
                            filaExcel.getCell(8).value = d.colH;
                            filaExcel.getCell(9).value = d.colI;
                            filaExcel.getCell(10).value = d.colJ;
                            filaExcel.getCell(11).value = d.colK;
                            filaExcel.getCell(12).value = d.colL;
                            filaExcel.getCell(13).value = d.colM;
                            filaExcel.getCell(14).value = d.colN;
                            filaExcel.getCell(15).value = d.colO;
                            filaExcel.getCell(16).value = d.colP;

                            filaExcel.commit();
                        });

                        // 6. GENERAR TXTs
                        mostrarEstado("4. Generando validaciones TXT...", "loading");
                        let txtLines = [];

                        datosMapeados.forEach(d => {
                            try {
                                // Mapeo para TXT según tu lógica python
                                // TIPO -> colC
                                // RUC -> colG
                                // SERIE -> colD
                                // NUMERO -> colE
                                // FECHA -> colB
                                // IMPORTE -> colL (Origen V)

                                // Parse TIPO
                                let tipoVal = parseInt(d.colC || 0);
                                let tipoStr = isNaN(tipoVal) ? "00" : tipoVal.toString().padStart(2, '0');
                                let tipoTxt = tipoStr + " ";

                                // Parse RUC
                                let rucVal = parseInt(d.colG || 0);
                                let rucTxt = (isNaN(rucVal) ? "" : rucVal.toString()).padEnd(18, " ");

                                // Parse SERIE
                                let serieRaw = d.colD ? d.colD.toString() : "";
                                let serieTxt = serieRaw.trim().toUpperCase().padEnd(20, " ");

                                // Parse NUMERO
                                let numVal = parseFloat(d.colE || 0); // a veces viene con decimales .0
                                let numTxt = (isNaN(numVal) ? "0" : parseInt(numVal).toString()).padEnd(18, " ");

                                // Parse FECHA
                                let fechaTxt = obtenerFechaStr(d.colB).trim();

                                // Parse IMPORTE
                                let impVal = parseFloat(d.colL || 0);
                                if (isNaN(impVal)) impVal = 0;

                                // Lógica Nota Crédito '07' -> Valor Absoluto
                                if (tipoStr === "07") {
                                    impVal = Math.abs(impVal);
                                }

                                // Redondeo
                                let impRedondeado = Math.round(impVal * 100) / 100;
                                let impTxt = impRedondeado.toString();
                                if (Number.isInteger(impRedondeado)) {
                                    impTxt = impRedondeado.toString(); // Sin decimales si es entero
                                }

                                const linea = `${rucTxt}|${tipoTxt}|${serieTxt}|${numTxt}|${fechaTxt}|${impTxt}`;
                                txtLines.push(linea);

                            } catch (err) {
                                console.warn("Error generando linea TXT:", err);
                            }
                        });

                        // 7. EMPAQUETAR EN ZIP
                        mostrarEstado("5. Creando archivo ZIP...", "loading");
                        const zip = new JSZip();

                        // Agregar Excel Modificado
                        const bufferFinalExcel = await wbSalida.xlsx.writeBuffer();
                        zip.file("Resumen_Compras_Final.xlsx", bufferFinalExcel);

                        // Agregar TXTs por lotes
                        const filasPorArchivo = 100;
                        for (let i = 0; i < txtLines.length; i += filasPorArchivo) {
                            const lote = txtLines.slice(i, i + filasPorArchivo).join("\n");
                            const numLote = Math.floor(i / filasPorArchivo) + 1;
                            zip.file(`Validacion_Final_Parte_${numLote}.txt`, lote);
                        }

                        // Descargar
                        const zipBlob = await zip.generateAsync({ type: "blob" });
                        saveAs(zipBlob, `AutoConta_Resultado_${Date.now()}.zip`);

                        mostrarEstado("¡Proceso Finalizado! Descarga iniciada.", "success");
                        btn.disabled = false;
                        btn.innerText = "Procesar y Descargar ZIP";

                    } catch (error) {
                        console.error(error);
                        mostrarEstado("Error: " + error.message, "error");
                        btn.disabled = false;
                        btn.innerText = "Procesar y Descargar ZIP";
                    }
                };

            } catch (err) {
                console.error(err);
                mostrarEstado("Error grave: " + err.message, "error");
                btn.disabled = false;
                btn.innerText = "Procesar y Descargar ZIP";
            }
        }
    </script>
</body>

</html>