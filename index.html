<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoContaLabs - Procesador de Compras ZIP</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 450px;
            text-align: center;
        }

        h1 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1.5rem;
        }

        .logo {
            color: #16a34a;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: block;
        }

        input[type="file"] {
            margin-bottom: 1rem;
            width: 100%;
        }

        button {
            background-color: #16a34a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
            font-size: 1rem;
        }

        button:hover {
            background-color: #15803d;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #status {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #444;
            white-space: pre-line;
            text-align: left;
            background: #f9fafb;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="card">
        <span class="logo">AutoContaLabs ðŸ›’</span>
        <h1>Procesador de Compras</h1>
        <p class="subtitle">Genera Resumen Excel + TXTs validados (ZIP)</p>

        <input type="file" id="inputFile" accept=".xlsx, .xls" />
        <button id="btnProcess" onclick="procesarCompras()">Generar ZIP</button>
        <div id="status"></div>
    </div>

    <script>
        async function procesarCompras() {
            const fileInput = document.getElementById('inputFile');
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('btnProcess');

            if (!fileInput.files[0]) {
                alert("Por favor selecciona un archivo Excel.");
                return;
            }

            try {
                btn.disabled = true;
                statusDiv.style.display = 'block';
                statusDiv.innerText = "â³ Iniciando lectura del archivo...";

                // 1. LEER EL ARCHIVO
                const reader = new FileReader();
                reader.readAsArrayBuffer(fileInput.files[0]);

                reader.onload = async function (e) {
                    const buffer = e.target.result;
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(buffer);
                    const worksheet = workbook.worksheets[0];

                    statusDiv.innerText += "\nðŸ” Filtrando datos y aplicando Regex...";

                    // 2. FILTRAR Y LIMPIAR (LÃ³gica Python traducida a JS)
                    let dfLimpio = [];
                    const regexFecha = /\d{2}\/\d{2}\/\d{4}/;

                    worksheet.eachRow({ includeEmpty: false }, function (row, rowNumber) {
                        // ExcelJS row.values[1] es null. La columna A es index 1, B es index 2.
                        // En tu Python usabas row[1] (Columna B). En ExcelJS suele ser index 2.
                        // Ajusta este Ã­ndice si tu Excel varÃ­a. Asumiremos Columna B (index 2).
                        const celdaFecha = row.getCell(2).value;

                        // Convertir a string para evaluar regex
                        let valorFechaStr = "";
                        if (celdaFecha instanceof Date) {
                            valorFechaStr = celdaFecha.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        } else if (celdaFecha) {
                            valorFechaStr = celdaFecha.toString();
                        }

                        if (regexFecha.test(valorFechaStr)) {
                            // Guardamos la fila completa (solo valores)
                            // row.values devuelve un array con un null al principio, lo quitamos con slice(1)
                            dfLimpio.push(row.values);
                        }
                    });

                    // 3. MAPEO DE COLUMNAS (Basado en tu cÃ³digo Python)
                    // Python indices (0-based) -> JS Array indices (1-based because row.values keeps index 0 as null/undefined usually)
                    // Mapeo aproximado basado en tu lista "columnas_nombres"
                    // [1] FECHA, [3] TIPO_CP, [4] SERIE, [6] NUMERO, [7] PROV_TIPO, [8] PROV_NUM, [9] PROV_NOM, [21] TOTAL

                    const datosProcesados = dfLimpio.map(row => {
                        return {
                            fecha: row[2],       // Python 1 -> JS 2 (Col B)
                            tipo_cp: row[4],     // Python 3 -> JS 4 (Col D)
                            serie: row[5],       // Python 4 -> JS 5 (Col E)
                            numero: row[7],      // Python 6 -> JS 7 (Col G)
                            prov_tipo: row[8],   // Python 7 -> JS 8 (Col H)
                            prov_ruc: row[9],    // Python 8 -> JS 9 (Col I)
                            prov_nom: row[10],   // Python 9 -> JS 10 (Col J)
                            total: row[22]       // Python 21 -> JS 22 (Col V)
                        };
                    });

                    statusDiv.innerText += "\nðŸ“Š Generando Excel de Resumen...";

                    // 4. GENERAR EXCEL RESUMEN
                    const wbResumen = new ExcelJS.Workbook();
                    const wsResumen = wbResumen.addWorksheet("Resumen");

                    // Encabezados
                    wsResumen.columns = [
                        { header: 'CORRELATIVO', key: 'corr', width: 10 },
                        { header: 'FECHA_EMISION', key: 'fecha', width: 15 },
                        { header: 'TIPO', key: 'tipo', width: 10 },
                        { header: 'SERIE', key: 'serie', width: 10 },
                        { header: 'NUMERO', key: 'num', width: 15 },
                        { header: 'TIPO DOC', key: 'tdoc', width: 10 },
                        { header: 'RUC', key: 'ruc', width: 15 },
                        { header: 'RAZON SOCIAL', key: 'rs', width: 30 },
                        { header: 'IMPORTE TOTAL', key: 'imp', width: 15 }
                    ];

                    datosProcesados.forEach((d, index) => {
                        wsResumen.addRow({
                            corr: index + 1,
                            fecha: d.fecha,
                            tipo: d.tipo_cp,
                            serie: d.serie,
                            num: d.numero,
                            tdoc: d.prov_tipo,
                            ruc: d.prov_ruc,
                            rs: d.prov_nom,
                            imp: d.total
                        });
                    });

                    const bufferResumen = await wbResumen.xlsx.writeBuffer();

                    statusDiv.innerText += "\nðŸ“ Generando lÃ­neas TXT y lotes...";

                    // 5. GENERAR LÃNEAS TXT (LÃ³gica estricta de formato)
                    let lineasTxt = [];

                    datosProcesados.forEach(fila => {
                        try {
                            // TIPO: int -> zfill(2)
                            let tipoRaw = parseInt(fila.tipo_cp || 0).toString().padStart(2, '0');
                            let tipo = (tipoRaw + " "); // Espacio extra segÃºn tu f-string "{tipo_val_raw} "

                            // RUC: ljust(18)
                            let ruc = (fila.prov_ruc || "").toString().padEnd(18, " ");

                            // SERIE: upper, strip, ljust(20)
                            let serie = (fila.serie || "").toString().trim().toUpperCase().padEnd(20, " ");

                            // NUMERO: int -> ljust(18)
                            let numero = parseInt(fila.numero || 0).toString().padEnd(18, " ");

                            // FECHA: strip
                            let fechaObj = fila.fecha;
                            let fechaStr = "";
                            if (fechaObj instanceof Date) {
                                fechaStr = fechaObj.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            } else {
                                fechaStr = (fechaObj || "").toString().trim();
                            }

                            // IMPORTE
                            let valorNum = parseFloat(fila.total || 0);
                            if (tipoRaw === "07") {
                                valorNum = Math.abs(valorNum);
                            }
                            let valorRedondeado = Math.round(valorNum * 100) / 100; // Round 2 decimales
                            let importeStr = valorRedondeado.toString();
                            // Si es entero visualmente
                            if (Number.isInteger(valorRedondeado)) {
                                importeStr = parseInt(valorRedondeado).toString();
                            }

                            // Construir lÃ­nea pipe-delimited
                            let linea = `${ruc}|${tipo}|${serie}|${numero}|${fechaStr}|${importeStr}`;
                            lineasTxt.push(linea);

                        } catch (err) {
                            console.warn("Error en fila", err);
                        }
                    });

                    // 6. CREAR ZIP
                    statusDiv.innerText += "\nðŸ“¦ Comprimiendo archivos...";
                    const zip = new JSZip();

                    // Agregar Excel al ZIP
                    zip.file("Resumen_Compras.xlsx", bufferResumen);

                    // Agregar TXTs por lotes de 100
                    const filasPorArchivo = 100;
                    for (let i = 0; i < lineasTxt.length; i += filasPorArchivo) {
                        const lote = lineasTxt.slice(i, i + filasPorArchivo);
                        const contenidoTxt = lote.join("\n");
                        const idxFile = Math.floor(i / filasPorArchivo) + 1;
                        zip.file(`Validacion_Final_Parte_${idxFile}.txt`, contenidoTxt);
                    }

                    // Generar Blob del ZIP
                    const zipBlob = await zip.generateAsync({ type: "blob" });

                    // 7. DESCARGAR
                    saveAs(zipBlob, "resultado_procesamiento.zip");

                    statusDiv.innerText += "\nâœ… Â¡Listo! Descarga iniciada.";
                    btn.disabled = false;
                };

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "âŒ Error: " + error.message;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>